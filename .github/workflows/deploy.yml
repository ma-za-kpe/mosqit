name: Mosqit CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    name: ğŸ” Lint & Test

    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run ESLint
        run: npm run lint

      - name: ğŸ§ª Run Tests
        run: npm test
        if: ${{ always() }}

      - name: ğŸ—ï¸ Build Dashboard
        run: npm run build
        env:
          NEXT_TELEMETRY_DISABLED: 1

      - name: ğŸ¯ Build Chrome Extension
        run: npm run build:extension

      - name: ğŸ“Š Check Bundle Size
        run: npm run analyze
        if: github.event_name == 'pull_request'

  deploy-develop:
    needs: lint-and-test
    runs-on: ubuntu-latest
    name: ğŸš€ Deploy to Development
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸŒ Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš¢ Deploy to Development
        run: |
          DEPLOYMENT_URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
          echo "DEPLOYMENT_URL=$DEPLOYMENT_URL" >> $GITHUB_ENV

      - name: ğŸ’¬ Comment PR with Preview URL
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **Mosqit Dashboard Preview Deployed!**\n\nğŸŒ Preview: ${process.env.DEPLOYMENT_URL}\n\nğŸ“± Test the PWA on mobile devices\nğŸ” Check DevTools integration\nğŸ¯ Verify Chrome AI APIs`
            })

  deploy-production:
    needs: lint-and-test
    runs-on: ubuntu-latest
    name: ğŸŒŸ Deploy to Production
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸš€ Install Vercel CLI
        run: npm install --global vercel@latest

      - name: ğŸŒ Pull Vercel Environment Information
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸ—ï¸ Build Project Artifacts
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: ğŸš¢ Deploy to Production
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: âœ… Production Deployment Success
        run: |
          echo "ğŸ‰ Mosqit Dashboard deployed to production!"
          echo "ğŸŒ Live at: https://mosqit.vercel.app"
          echo "ğŸ¦Ÿ Chrome Extension ready for hackathon!"

  build-extension:
    needs: lint-and-test
    runs-on: ubuntu-latest
    name: ğŸ“¦ Build & Package Extension
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¯ Build Chrome Extension
        run: npm run build:extension:prod

      - name: ğŸ“¦ Package Extension
        run: npm run package:extension

      - name: ğŸ“¤ Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: mosqit-extension-${{ github.sha }}
          path: dist/mosqit-extension-*.zip

      - name: ğŸ“Š Extension Size Report
        run: |
          echo "ğŸ“¦ Extension Package Info:"
          ls -lh dist/*.zip
          unzip -l dist/mosqit-extension-*.zip | tail -1

  release:
    needs: [deploy-production, build-extension]
    runs-on: ubuntu-latest
    name: ğŸ‰ Create Release
    if: github.ref == 'refs/heads/main' && contains(github.event.head_commit.message, '[release]')

    steps:
      - name: ğŸ”¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¥ Download Extension Artifact
        uses: actions/download-artifact@v4
        with:
          name: mosqit-extension-${{ github.sha }}

      - name: ğŸ·ï¸ Get Version
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ‰ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Mosqit v${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ¦Ÿ Mosqit Chrome Extension Release

            ### âœ¨ What's New
            - Chrome AI APIs integration (Gemini Nano)
            - DevTools DOM Preview screenshots
            - AI-powered GitHub issue generation
            - Offline-first architecture
            - Mobile dashboard support

            ### ğŸ“¦ Installation
            1. Download the extension ZIP file below
            2. Open Chrome Canary with flags: `--enable-experimental-web-platform-features`
            3. Navigate to `chrome://extensions/`
            4. Enable Developer Mode
            5. Drag and drop the ZIP file to install

            ### ğŸŒ Live Dashboard
            Visit: [https://mosqit.vercel.app](https://mosqit.vercel.app)

            ### ğŸ† Chrome Built-in AI Challenge 2025
            This release is our submission for the Google Chrome Built-in AI Challenge 2025

            ---
            **Full Changelog**: https://github.com/${{ github.repository }}/commits/v${{ steps.version.outputs.VERSION }}
          files: |
            mosqit-extension-*.zip
          draft: false
          prerelease: false

  notify:
    needs: [deploy-production, build-extension]
    runs-on: ubuntu-latest
    name: ğŸ“¢ Notify Team
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: ğŸ”” Send Success Notification
        run: |
          echo "âœ… Deployment successful!"
          echo "ğŸ“ Dashboard: https://mosqit.vercel.app"
          echo "ğŸ¯ Extension: Built and packaged"
          echo "ğŸ“… Timestamp: $(date)"

      - name: ğŸ“Š Deployment Summary
        run: |
          echo "## ğŸ“Š Deployment Summary"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Commit: ${{ github.sha }}"
          echo "- Author: ${{ github.actor }}"
          echo "- Message: ${{ github.event.head_commit.message }}"